{% extends "base.html" %}

{% block title %}Deal Simulation — Prism{% endblock %}

{% block content %}
<div class="space-y-8">
    
    <!-- Header -->
    <div>
        <h1 class="text-3xl font-bold text-white">Deal Simulation</h1>
        <p class="mt-2 text-dark-400">Model scenario changes and predict deal outcomes</p>
    </div>
    
    <!-- Setup -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Simulation Form -->
        <div class="gradient-border rounded-xl p-6">
            <h2 class="text-lg font-semibold text-white mb-6 flex items-center gap-2">
                <i data-lucide="settings-2" class="w-5 h-5 text-accent"></i>
                Scenario Setup
            </h2>
            
            <form method="POST" class="space-y-6">
                <!-- Prospect Selection -->
                <div>
                    <label class="block text-sm font-medium text-dark-300 mb-2">Select Deal</label>
                    <select name="prospect_id" required
                            class="w-full px-4 py-3 rounded-xl bg-dark-800 border border-dark-700 
                                   text-white text-sm focus:outline-none focus:border-accent/50 focus:ring-2 focus:ring-accent/20 transition-all">
                        <option value="">Choose a deal to simulate...</option>
                        {% for t in timelines %}
                        <option value="{{ t.prospect_id }}" {{ 'selected' if t.prospect_name == selected_prospect else '' }}>
                            {{ t.prospect_name }} — {{ t.company }} ({{ t.current_stage_display }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- Scenario Changes -->
                <div>
                    <label class="block text-sm font-medium text-dark-300 mb-3">Scenario Changes</label>
                    
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 p-4 rounded-xl bg-dark-800/50 border border-dark-700 cursor-pointer hover:border-dark-600 transition-all">
                            <input type="checkbox" name="rep_change" class="w-5 h-5 rounded bg-dark-700 border-dark-600 text-accent focus:ring-accent/50">
                            <div>
                                <div class="font-medium text-dark-100">New Rep Assignment</div>
                                <div class="text-xs text-dark-500">Simulate fresh approach with different rep</div>
                            </div>
                        </label>
                        
                        <label class="flex items-center gap-3 p-4 rounded-xl bg-dark-800/50 border border-dark-700 cursor-pointer hover:border-dark-600 transition-all">
                            <input type="checkbox" name="remove_objection" class="w-5 h-5 rounded bg-dark-700 border-dark-600 text-accent focus:ring-accent/50">
                            <div>
                                <div class="font-medium text-dark-100">Resolve Main Objection</div>
                                <div class="text-xs text-dark-500">What if the primary blocker was removed?</div>
                            </div>
                        </label>
                        
                        <label class="flex items-center gap-3 p-4 rounded-xl bg-dark-800/50 border border-dark-700 cursor-pointer hover:border-dark-600 transition-all">
                            <input type="checkbox" name="add_champion" class="w-5 h-5 rounded bg-dark-700 border-dark-600 text-accent focus:ring-accent/50">
                            <div>
                                <div class="font-medium text-dark-100">Add Internal Champion</div>
                                <div class="text-xs text-dark-500">Simulate having a strong internal advocate</div>
                            </div>
                        </label>
                        
                        <div class="p-4 rounded-xl bg-dark-800/50 border border-dark-700">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <div class="font-medium text-dark-100">Timing Speedup</div>
                                    <div class="text-xs text-dark-500">Accelerate deal velocity</div>
                                </div>
                                <span class="text-sm font-mono text-accent" id="speedupValue">1.0x</span>
                            </div>
                            <input type="range" name="timing_speedup" min="0.5" max="2" step="0.1" value="1"
                                   class="w-full h-2 bg-dark-700 rounded-full appearance-none cursor-pointer
                                          [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-4 [&::-webkit-slider-thumb]:h-4 
                                          [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-accent"
                                   id="speedupSlider">
                        </div>
                    </div>
                </div>
                
                <!-- Submit -->
                <button type="submit"
                        class="w-full flex items-center justify-center gap-2 px-6 py-3 rounded-xl 
                               bg-gradient-to-r from-accent to-purple-500 hover:from-accent-dim hover:to-purple-600
                               text-white font-semibold transition-all hover:shadow-glow">
                    <i data-lucide="play" class="w-5 h-5"></i>
                    Run Simulation
                </button>
            </form>
        </div>
        
        <!-- How It Works -->
        <div class="gradient-border rounded-xl p-6">
            <h2 class="text-lg font-semibold text-white mb-6 flex items-center gap-2">
                <i data-lucide="info" class="w-5 h-5 text-blue-400"></i>
                How It Works
            </h2>
            
            <div class="space-y-6">
                <p class="text-dark-300">
                    Deal simulation uses historical transition data and deal patterns to model 
                    how changes might affect win probability and timeline.
                </p>
                
                <div class="space-y-4">
                    <div class="flex items-start gap-4">
                        <div class="w-8 h-8 rounded-lg bg-accent/20 flex items-center justify-center flex-shrink-0">
                            <span class="text-sm font-bold text-accent">1</span>
                        </div>
                        <div>
                            <div class="font-medium text-dark-100">Baseline Calculation</div>
                            <p class="text-sm text-dark-400 mt-1">We calculate current win probability based on stage, timeline, and transition patterns.</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start gap-4">
                        <div class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center flex-shrink-0">
                            <span class="text-sm font-bold text-purple-400">2</span>
                        </div>
                        <div>
                            <div class="font-medium text-dark-100">Scenario Modeling</div>
                            <p class="text-sm text-dark-400 mt-1">Your selected changes are applied with calibrated impact factors.</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start gap-4">
                        <div class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center flex-shrink-0">
                            <span class="text-sm font-bold text-emerald-400">3</span>
                        </div>
                        <div>
                            <div class="font-medium text-dark-100">Probability Adjustment</div>
                            <p class="text-sm text-dark-400 mt-1">New win probability and timeline estimates are computed.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results -->
    {% if results %}
    <div class="gradient-border rounded-xl p-8 animate-fade-in">
        <h2 class="text-xl font-semibold text-white mb-8 flex items-center gap-2">
            <i data-lucide="bar-chart-3" class="w-6 h-6 text-accent"></i>
            Simulation Results: {{ results.prospect_name }}
        </h2>
        
        <!-- Win Probability Comparison -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Baseline -->
            <div class="p-6 rounded-xl bg-dark-800/50 border border-dark-700 text-center">
                <div class="text-sm text-dark-400 mb-2">Baseline Win Probability</div>
                <div class="text-4xl font-bold text-white">{{ results.base_win_probability }}%</div>
                <div class="text-sm text-dark-500 mt-2">Current likelihood</div>
            </div>
            
            <!-- Arrow -->
            <div class="flex items-center justify-center">
                <div class="w-16 h-16 rounded-full bg-accent/20 flex items-center justify-center">
                    <i data-lucide="arrow-right" class="w-8 h-8 text-accent"></i>
                </div>
            </div>
            
            <!-- Modified -->
            <div class="p-6 rounded-xl border text-center
                        {{ 'bg-success/10 border-success/30' if results.probability_change > 0 else 'bg-danger/10 border-danger/30' if results.probability_change < 0 else 'bg-dark-800/50 border-dark-700' }}">
                <div class="text-sm text-dark-400 mb-2">Modified Win Probability</div>
                <div class="text-4xl font-bold {{ 'text-success' if results.probability_change > 0 else 'text-danger' if results.probability_change < 0 else 'text-white' }}">
                    {{ results.modified_win_probability }}%
                </div>
                <div class="text-sm mt-2 {{ 'text-success' if results.probability_change > 0 else 'text-danger' if results.probability_change < 0 else 'text-dark-500' }}">
                    {{ '+' if results.probability_change > 0 else '' }}{{ results.probability_change }}% change
                </div>
            </div>
        </div>
        
        <!-- Changes Applied -->
        {% if results.changes_applied %}
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-white mb-4">Changes Applied</h3>
            <div class="flex flex-wrap gap-3">
                {% for change in results.changes_applied %}
                <div class="flex items-center gap-2 px-4 py-2 rounded-xl bg-accent/10 border border-accent/30">
                    <i data-lucide="check" class="w-4 h-4 text-accent"></i>
                    <span class="text-sm text-dark-100">{{ change }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Timeline & Recommendation -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="p-6 rounded-xl bg-dark-800/50 border border-dark-700">
                <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="calendar" class="w-5 h-5 text-amber-400"></i>
                    <span class="font-medium text-white">Estimated Days to Close</span>
                </div>
                <div class="text-3xl font-bold text-white mt-2">{{ results.estimated_days_to_close }} days</div>
            </div>
            
            <div class="p-6 rounded-xl bg-accent/5 border border-accent/20">
                <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="lightbulb" class="w-5 h-5 text-accent"></i>
                    <span class="font-medium text-white">Recommendation</span>
                </div>
                <p class="text-dark-200 mt-2">{{ results.recommendation }}</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    lucide.createIcons();
    
    // Speedup slider
    const slider = document.getElementById('speedupSlider');
    const value = document.getElementById('speedupValue');
    
    if (slider) {
        slider.addEventListener('input', () => {
            value.textContent = slider.value + 'x';
        });
    }
</script>
{% endblock %}
