{% extends "base.html" %}

{% block title %}{{ prospect.name }} — Sales Intelligence{% endblock %}

{% block content %}
<div class="space-y-10">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-sm text-ink-400">
        <a href="{{ url_for('pipeline') }}" class="hover:text-ink-600 transition-subtle">Pipeline</a>
        <span>/</span>
        <span class="text-ink-700">{{ prospect.name }}</span>
    </nav>
    
    <!-- Header Card -->
    <div class="bg-white rounded-xl p-8 shadow-soft">
        <div class="flex items-start justify-between">
            <div class="flex items-center gap-5">
                <div class="w-16 h-16 rounded-full bg-cream-100 flex items-center justify-center text-ink-600 text-2xl font-serif">
                    {{ prospect.name[0] }}
                </div>
                <div>
                    <h1 class="text-2xl font-serif font-semibold">{{ prospect.name }}</h1>
                    <div class="text-ink-500 mt-1">{{ prospect.title }}</div>
                    <div class="flex items-center gap-3 mt-3">
                        <span class="px-3 py-1 rounded-full text-sm font-medium stage-{{ timeline.current_stage if timeline else 'discovery' }}"
                              style="background: color-mix(in srgb, var(--stage-color) 12%, white); color: var(--stage-color);">
                            {{ stage_display.get(timeline.current_stage, 'Discovery') if timeline else 'Discovery' }}
                        </span>
                        {% if timeline and timeline.is_stalled %}
                        <span class="px-3 py-1 rounded-full text-sm font-medium bg-amber-50 text-amber-700">
                            Stalled {{ timeline.stall_days }}d
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="text-right">
                <div class="text-lg font-medium text-ink-700">{{ prospect.company }}</div>
                {% if prospect.email %}
                <a href="mailto:{{ prospect.email }}" class="text-sm text-ink-400 hover:text-accent transition-subtle">
                    {{ prospect.email }}
                </a>
                {% endif %}
            </div>
        </div>
        
        <!-- Timeline Progress -->
        {% if timeline %}
        <div class="mt-8 pt-8 border-t border-cream-200">
            <div class="flex items-center justify-between mb-4">
                <span class="text-sm text-ink-500">Deal Progress</span>
                <span class="text-sm text-ink-400">{{ timeline.total_days|default(0) }} days total</span>
            </div>
            <div class="flex gap-1">
                {% for stage in stages[:8] %}
                    {% set in_stage = false %}
                    {% for s in timeline.stages %}
                        {% if s.stage == stage %}
                            {% set in_stage = true %}
                        {% endif %}
                    {% endfor %}
                    <div class="relative flex-1 group">
                        <div class="h-2 rounded-full {{ 'stage-' + stage if in_stage else 'bg-cream-200' }}"
                             style="{{ 'background: var(--stage-color); opacity: 0.7;' if in_stage else '' }}"></div>
                        <div class="absolute -bottom-6 left-1/2 -translate-x-1/2 text-xs text-ink-400 opacity-0 group-hover:opacity-100 transition-subtle whitespace-nowrap">
                            {{ stage_display.get(stage, stage) }}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Left Column: Details -->
        <div class="lg:col-span-2 space-y-8">
            
            <!-- Personality & Style -->
            <div class="bg-white rounded-xl p-8 shadow-soft">
                <h2 class="text-lg font-serif font-semibold mb-6">Personality Profile</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Traits -->
                    <div>
                        <div class="text-xs text-ink-400 uppercase tracking-wider mb-3">Traits</div>
                        <div class="flex flex-wrap gap-2">
                            {% for trait in prospect.personality_traits %}
                            <span class="px-2 py-1 rounded-lg text-xs bg-violet-50 text-violet-700">
                                {{ trait if trait is string else trait.trait|default(trait) }}
                            </span>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Communication -->
                    <div>
                        <div class="text-xs text-ink-400 uppercase tracking-wider mb-3">Communication</div>
                        <div class="text-sm text-ink-700">
                            {{ prospect.communication_style if prospect.communication_style is string else prospect.communication_style.style|default(prospect.communication_style) }}
                        </div>
                    </div>
                    
                    <!-- Decision Style -->
                    <div>
                        <div class="text-xs text-ink-400 uppercase tracking-wider mb-3">Decision Style</div>
                        <div class="text-sm text-ink-700">
                            {{ prospect.decision_style if prospect.decision_style is string else prospect.decision_style.style|default(prospect.decision_style) }}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pain Points -->
            <div class="bg-white rounded-xl p-8 shadow-soft">
                <h2 class="text-lg font-serif font-semibold mb-6">Pain Points</h2>
                
                {% if prospect.pain_points %}
                <div class="space-y-4">
                    {% for pp in prospect.pain_points %}
                    {% set sev_colors = {'critical': 'red', 'high': 'orange', 'medium': 'amber', 'low': 'emerald'} %}
                    {% set sev_color = sev_colors.get(pp.severity, 'gray') %}
                    <div class="p-4 rounded-lg bg-cream-50 border-l-3 border-{{ sev_color }}-400" style="border-left-width: 3px;">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="font-medium text-sm">{{ pp.description }}</div>
                                {% if pp.verbatim_quote %}
                                <div class="mt-2 text-sm text-ink-500 italic">
                                    "{{ pp.verbatim_quote }}"
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex items-center gap-2 ml-4">
                                <span class="px-2 py-0.5 rounded text-xs font-medium bg-{{ sev_color }}-50 text-{{ sev_color }}-700">
                                    {{ pp.severity }}
                                </span>
                                <span class="px-2 py-0.5 rounded text-xs bg-cream-100 text-ink-500">
                                    {{ pp.category }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-ink-400 text-center py-6">No pain points identified yet</p>
                {% endif %}
            </div>
            
            <!-- Objections -->
            {% if prospect.objections %}
            <div class="bg-white rounded-xl p-8 shadow-soft">
                <h2 class="text-lg font-serif font-semibold mb-6">Objections & Concerns</h2>
                
                <div class="space-y-4">
                    {% for obj in prospect.objections %}
                    <div class="p-4 rounded-lg bg-cream-50">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="font-medium text-sm">{{ obj.description }}</div>
                                {% if obj.what_would_resolve %}
                                <div class="mt-2 text-sm text-ink-500">
                                    <span class="text-emerald-600 font-medium">Resolution:</span> {{ obj.what_would_resolve }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex items-center gap-2 ml-4">
                                <span class="px-2 py-0.5 rounded text-xs bg-cream-100 text-ink-500">
                                    {{ obj.type }}
                                </span>
                                <span class="px-2 py-0.5 rounded text-xs 
                                    {{ 'bg-emerald-50 text-emerald-700' if obj.resolution_status == 'resolved' else '' }}
                                    {{ 'bg-amber-50 text-amber-700' if obj.resolution_status == 'partially_resolved' else '' }}
                                    {{ 'bg-red-50 text-red-700' if obj.resolution_status == 'unresolved' else '' }}">
                                    {{ obj.resolution_status }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Buying Signals -->
            {% if prospect.buying_signals %}
            <div class="bg-white rounded-xl p-8 shadow-soft">
                <h2 class="text-lg font-serif font-semibold mb-6">Buying Signals</h2>
                
                <div class="space-y-4">
                    {% for sig in prospect.buying_signals %}
                    <div class="p-4 rounded-lg bg-emerald-50/50 border-l-3 border-emerald-400" style="border-left-width: 3px;">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="font-medium text-sm">{{ sig.signal }}</div>
                                {% if sig.verbatim_quote %}
                                <div class="mt-2 text-sm text-ink-500 italic">
                                    "{{ sig.verbatim_quote }}"
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex items-center gap-2 ml-4">
                                <span class="px-2 py-0.5 rounded text-xs 
                                    {{ 'bg-emerald-100 text-emerald-700' if sig.strength == 'strong' else '' }}
                                    {{ 'bg-blue-50 text-blue-700' if sig.strength == 'moderate' else '' }}
                                    {{ 'bg-cream-100 text-ink-500' if sig.strength == 'weak' else '' }}">
                                    {{ sig.strength }}
                                </span>
                                <span class="px-2 py-0.5 rounded text-xs bg-cream-100 text-ink-500">
                                    {{ sig.type }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Right Column: Actions & Intelligence -->
        <div class="space-y-8">
            
            <!-- Key Questions -->
            {% if prospect.uncertainties %}
            <div class="bg-white rounded-xl p-6 shadow-soft">
                <h2 class="text-lg font-serif font-semibold mb-5">Key Questions</h2>
                
                <div class="space-y-3">
                    {% for u in prospect.uncertainties[:5] %}
                    <div class="p-3 rounded-lg bg-cream-50">
                        <div class="flex items-start gap-2">
                            <span class="mt-0.5 px-1.5 py-0.5 rounded text-xs 
                                {{ 'bg-red-50 text-red-700' if u.impact == 'high' else '' }}
                                {{ 'bg-amber-50 text-amber-700' if u.impact == 'medium' else '' }}
                                {{ 'bg-cream-100 text-ink-500' if u.impact == 'low' else '' }}">
                                {{ u.impact }}
                            </span>
                            <div class="flex-1">
                                <div class="text-sm font-medium">{{ u.question }}</div>
                                <div class="text-xs text-ink-400 mt-1">{{ u.suggested_action }}</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Next Steps -->
            {% if prospect.next_steps %}
            <div class="bg-white rounded-xl p-6 shadow-soft">
                <h2 class="text-lg font-serif font-semibold mb-5">Next Steps</h2>
                
                <div class="space-y-3">
                    {% for ns in prospect.next_steps %}
                    <div class="p-3 rounded-lg bg-cream-50">
                        <div class="flex items-start gap-3">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center mt-0.5
                                {{ 'bg-accent/10' if ns.owner == 'rep' else '' }}
                                {{ 'bg-violet-50' if ns.owner == 'prospect' else '' }}
                                {{ 'bg-blue-50' if ns.owner == 'both' else '' }}">
                                <i data-lucide="{{ 'user' if ns.owner == 'rep' else 'users' }}" 
                                   class="w-3 h-3 {{ 'text-accent' if ns.owner == 'rep' else 'text-violet-600' if ns.owner == 'prospect' else 'text-blue-600' }}"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-sm">{{ ns.action }}</div>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-xs text-ink-400">{{ ns.owner }}</span>
                                    <span class="text-xs px-1.5 py-0.5 rounded 
                                        {{ 'bg-emerald-50 text-emerald-700' if ns.commitment_level == 'firm' else 'bg-cream-100 text-ink-500' }}">
                                        {{ ns.commitment_level }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Stakeholders -->
            {% if prospect.stakeholders %}
            <div class="bg-white rounded-xl p-6 shadow-soft">
                <h2 class="text-lg font-serif font-semibold mb-5">Stakeholders</h2>
                
                <div class="space-y-3">
                    {% for sh in prospect.stakeholders %}
                    <div class="flex items-center gap-3 p-3 rounded-lg bg-cream-50">
                        <div class="w-8 h-8 rounded-full bg-violet-100 flex items-center justify-center text-violet-700 text-sm font-medium">
                            {{ sh.name[0] if sh.name and sh.name != 'unknown' else '?' }}
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-medium">{{ sh.name if sh.name and sh.name != 'unknown' else sh.role }}</div>
                            <div class="flex items-center gap-2 text-xs text-ink-400">
                                <span>{{ sh.influence }}</span>
                                <span>·</span>
                                <span class="{{ 'text-emerald-600' if sh.sentiment == 'positive' else 'text-red-600' if sh.sentiment == 'negative' else '' }}">
                                    {{ sh.sentiment }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Quick Actions -->
            <div class="bg-white rounded-xl p-6 shadow-soft">
                <h2 class="text-lg font-serif font-semibold mb-5">Actions</h2>
                
                <div class="space-y-2">
                    <a href="{{ url_for('simulation') }}?prospect={{ prospect.id }}" 
                       class="flex items-center gap-3 p-3 rounded-lg bg-cream-50 hover:bg-cream-100 transition-subtle">
                        <i data-lucide="sparkles" class="w-4 h-4 text-ink-400"></i>
                        <span class="text-sm">Run Simulation</span>
                    </a>
                    <button class="flex items-center gap-3 p-3 rounded-lg bg-cream-50 hover:bg-cream-100 transition-subtle w-full text-left">
                        <i data-lucide="mail" class="w-4 h-4 text-ink-400"></i>
                        <span class="text-sm">Generate Follow-up</span>
                    </button>
                    <button class="flex items-center gap-3 p-3 rounded-lg bg-cream-50 hover:bg-cream-100 transition-subtle w-full text-left">
                        <i data-lucide="message-circle" class="w-4 h-4 text-ink-400"></i>
                        <span class="text-sm">Practice Conversation</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    lucide.createIcons();
</script>
{% endblock %}
