{% extends "base.html" %}

{% block title %}Pipeline â€” Sales Intelligence{% endblock %}

{% block content %}
<div class="space-y-10">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div class="text-center flex-1">
            <h1 class="text-3xl font-serif font-semibold tracking-tight">Pipeline</h1>
            <p class="text-ink-500 mt-2">{{ total_deals }} deals across all stages</p>
        </div>
        <a href="{{ url_for('upload') }}" class="px-4 py-2 rounded-lg bg-ink-900 text-white hover:bg-ink-800 transition-subtle text-sm font-medium">
            Add Deal
        </a>
    </div>
    
    <!-- Kanban Board -->
    <div class="overflow-x-auto pb-4 -mx-6 px-6">
        <div class="flex gap-5 min-w-max">
            {% for stage in stages %}
                {% if stage not in ['closed_won', 'closed_lost'] %}
                <div class="w-72 flex-shrink-0">
                    <!-- Column Header -->
                    <div class="flex items-center justify-between mb-4 px-1">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full stage-{{ stage }}" style="background: var(--stage-color);"></div>
                            <h3 class="font-medium text-sm text-ink-700">{{ stage_display[stage] }}</h3>
                        </div>
                        <span class="text-xs text-ink-400 bg-cream-100 px-2 py-0.5 rounded-full">
                            {{ by_stage[stage]|length }}
                        </span>
                    </div>
                    
                    <!-- Cards Container -->
                    <div class="space-y-3 min-h-[200px] p-3 rounded-xl bg-cream-100/50">
                        {% for deal in by_stage[stage] %}
                        <a href="{{ url_for('prospect_detail', prospect_id=deal.prospect_id) }}"
                           class="block p-4 rounded-lg bg-white shadow-soft hover:shadow-card transition-subtle">
                            <!-- Deal Header -->
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <div class="w-7 h-7 rounded-full bg-cream-100 flex items-center justify-center text-ink-600 text-xs font-medium">
                                        {{ deal.prospect_name[0] }}
                                    </div>
                                    <div>
                                        <div class="font-medium text-sm hover:text-accent transition-subtle">
                                            {{ deal.prospect_name }}
                                        </div>
                                        <div class="text-xs text-ink-400">{{ deal.company }}</div>
                                    </div>
                                </div>
                                {% if deal.is_stalled %}
                                <span class="text-xs text-amber-600 bg-amber-50 px-1.5 py-0.5 rounded">
                                    Stalled
                                </span>
                                {% endif %}
                            </div>
                            
                            <!-- Deal Info -->
                            <div class="space-y-2">
                                <div class="flex items-center gap-2 text-xs text-ink-400">
                                    <i data-lucide="clock" class="w-3 h-3"></i>
                                    <span>{{ deal.total_days|default(0) }} days</span>
                                </div>
                                
                                <!-- Stage Progress -->
                                <div class="flex gap-0.5">
                                    {% for s in stages[:7] %}
                                        {% set is_completed = false %}
                                        {% for ds in deal.stages %}
                                            {% if ds.stage == s %}
                                                {% set is_completed = true %}
                                            {% endif %}
                                        {% endfor %}
                                        <div class="h-1 flex-1 rounded-full {{ 'stage-' + s if is_completed or s == deal.current_stage else 'bg-cream-200' }}"
                                             style="{{ 'background: var(--stage-color); opacity: 0.6;' if is_completed or s == deal.current_stage else '' }}"></div>
                                    {% endfor %}
                                </div>
                            </div>
                        </a>
                        {% else %}
                        <div class="p-6 text-center text-ink-400 text-sm">
                            <i data-lucide="inbox" class="w-6 h-6 mx-auto mb-2 opacity-40"></i>
                            No deals
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            {% endfor %}
            
            <!-- Closed Columns -->
            <div class="w-72 flex-shrink-0 space-y-5">
                <!-- Won Column -->
                <div>
                    <div class="flex items-center justify-between mb-4 px-1">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                            <h3 class="font-medium text-sm text-emerald-700">Won</h3>
                        </div>
                        <span class="text-xs text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full">
                            {{ by_stage['closed_won']|length }}
                        </span>
                    </div>
                    
                    <div class="space-y-2 min-h-[80px] p-3 rounded-xl bg-emerald-50/50">
                        {% for deal in by_stage['closed_won'] %}
                        <div class="p-3 rounded-lg bg-white shadow-soft">
                            <div class="flex items-center gap-2">
                                <i data-lucide="check" class="w-4 h-4 text-emerald-500"></i>
                                <span class="text-sm font-medium">{{ deal.prospect_name }}</span>
                            </div>
                            <div class="text-xs text-ink-400 mt-1 ml-6">{{ deal.company }}</div>
                        </div>
                        {% else %}
                        <div class="p-4 text-center text-emerald-400 text-sm">
                            No won deals yet
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Lost Column -->
                <div>
                    <div class="flex items-center justify-between mb-4 px-1">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-red-500"></div>
                            <h3 class="font-medium text-sm text-red-700">Lost</h3>
                        </div>
                        <span class="text-xs text-red-600 bg-red-50 px-2 py-0.5 rounded-full">
                            {{ by_stage['closed_lost']|length }}
                        </span>
                    </div>
                    
                    <div class="space-y-2 min-h-[80px] p-3 rounded-xl bg-red-50/50">
                        {% for deal in by_stage['closed_lost'] %}
                        <div class="p-3 rounded-lg bg-white shadow-soft">
                            <div class="flex items-center gap-2">
                                <i data-lucide="x" class="w-4 h-4 text-red-500"></i>
                                <span class="text-sm font-medium">{{ deal.prospect_name }}</span>
                            </div>
                            <div class="text-xs text-ink-400 mt-1 ml-6">{{ deal.company }}</div>
                        </div>
                        {% else %}
                        <div class="p-4 text-center text-red-400 text-sm">
                            No lost deals
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    lucide.createIcons();
</script>
{% endblock %}
