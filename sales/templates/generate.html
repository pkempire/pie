{% extends "base.html" %}
{% block title %}Generate Campaign — Prism{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-2">Generate Campaign</h1>
    <p class="text-gray-500 mb-6">Create a personalized email sequence using Box Public Sector messaging</p>
    
    <div class="grid grid-cols-2 gap-6">
        <!-- Input Form -->
        <div>
            <form method="POST" class="bg-white rounded-xl border p-6 space-y-4">
                {% if prospects %}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Target Prospect (optional)</label>
                    <select name="prospect_id" class="w-full border rounded-lg px-3 py-2">
                        <option value="">— Generic sequence —</option>
                        {% for p in prospects %}
                        <option value="{{ p.id }}" {% if request.args.get('prospect_id') == p.id %}selected{% endif %}>
                            {{ p.name }} at {{ p.company }} ({{ p.stage }})
                        </option>
                        {% endfor %}
                    </select>
                    <div class="text-xs text-gray-400 mt-1">Selecting a prospect personalizes the sequence to their pain points</div>
                </div>
                {% endif %}
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Target Persona *</label>
                    <input type="text" name="persona" required class="w-full border rounded-lg px-3 py-2" 
                           placeholder="e.g., State OSHA Director of Enforcement">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Agency/Department</label>
                    <input type="text" name="agency" class="w-full border rounded-lg px-3 py-2" 
                           placeholder="e.g., California Department of Industrial Relations">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Use Case Theme</label>
                    <select name="use_case" class="w-full border rounded-lg px-3 py-2">
                        <option value="ecm">ECM Modernization (replace FileNet/OpenText)</option>
                        <option value="security">Security & Compliance (Shield Pro)</option>
                        <option value="cmmc">CMMC 2.0 Compliance</option>
                        <option value="foia">FOIA/Records Management</option>
                        <option value="ai">AI & Automation</option>
                    </select>
                </div>
                
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-medium">
                    ✨ Generate 3-Touch Sequence
                </button>
            </form>
            
            <!-- Value Props Reference -->
            {% if agent_config.value_props %}
            <div class="mt-6 bg-gray-50 rounded-xl p-4">
                <h3 class="font-medium text-sm mb-2">Box Value Props (included)</h3>
                <ul class="text-xs text-gray-600 space-y-1">
                    {% for vp in agent_config.value_props %}
                    <li>• {{ vp }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        
        <!-- Generated Output -->
        <div>
            {% if generated and generated.emails %}
            <div class="bg-white rounded-xl border divide-y">
                <div class="p-4 bg-green-50">
                    <div class="font-semibold text-green-800">✅ Campaign Generated</div>
                    <div class="text-sm text-green-600">{{ generated.emails|length }} emails ready to use</div>
                </div>
                
                {% for email in generated.emails %}
                <div class="p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs font-medium">{{ email.touch }}</span>
                    </div>
                    <div class="mb-3">
                        <div class="text-xs text-gray-400 uppercase mb-1">Subject</div>
                        <div class="font-medium text-sm">{{ email.subject }}</div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-400 uppercase mb-1">Body</div>
                        <div class="text-sm text-gray-700 whitespace-pre-wrap bg-gray-50 rounded p-3 max-h-48 overflow-y-auto">{{ email.body }}</div>
                    </div>
                    <button onclick="copyEmail('{{ email.subject }}', `{{ email.body|e }}`)" class="mt-2 text-xs text-blue-600 hover:underline">
                        Copy to clipboard
                    </button>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="bg-gray-50 rounded-xl border-2 border-dashed border-gray-200 p-12 text-center">
                <div class="text-4xl mb-4">✨</div>
                <div class="text-gray-500">Fill out the form and generate a personalized email sequence</div>
                <div class="text-sm text-gray-400 mt-2">Uses GPT-4o-mini with Box messaging guidelines</div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function copyEmail(subject, body) {
    const text = `Subject: ${subject}\n\n${body}`;
    navigator.clipboard.writeText(text);
    alert('Copied to clipboard!');
}
</script>
{% endblock %}
